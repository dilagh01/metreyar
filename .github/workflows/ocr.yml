name: OCR to HTML

on:
  push:
    paths:
      - 'input_files/**'
  workflow_dispatch:

jobs:
  ocr-job:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OCR dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr poppler-utils default-jre libglib2.0-0

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install pillow pytesseract pdf2image pandas openpyxl tabula-py PyMuPDF

    - name: Process files
      run: |
        mkdir -p output_html
        for file in input_files/*; do
          filename=$(basename "$file")
          extension="${filename##*.}"
          name="${filename%.*}"

          if [[ "$extension" =~ ^(png|jpg|jpeg|bmp)$ ]]; then
            python - <<EOF
from PIL import Image
import pytesseract
import os

file_path = "$file"
name = "$name"

img = Image.open(file_path)
text = pytesseract.image_to_string(img, lang='eng')

html_content = f"""<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>OCR Result - {name}</title>
<style>
  body {{
    background-color: white;
    color: black;
    font-family: Arial, sans-serif;
    padding: 20px;
    white-space: pre-wrap;
  }}
</style>
</head>
<body>
<pre>{text}</pre>
</body>
</html>
"""
os.makedirs("output_html", exist_ok=True)
with open(f"output_html/{name}.html", "w", encoding="utf-8") as f:
    f.write(html_content)
EOF

          elif [[ "$extension" == "pdf" ]]; then
            python - <<EOF
from pdf2image import convert_from_path
import pytesseract
import os

file_path = "$file"
name = "$name"

images = convert_from_path(file_path)
text = ""
for img in images:
    text += pytesseract.image_to_string(img, lang='eng')

html_content = f"""<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>OCR Result - {name}</title>
<style>
  body {{
    background-color: white;
    color: black;
    font-family: Arial, sans-serif;
    padding: 20px;
    white-space: pre-wrap;
  }}
</style>
</head>
<body>
<pre>{text}</pre>
</body>
</html>
"""
os.makedirs("output_html", exist_ok=True)
with open(f"output_html/{name}.html", "w", encoding="utf-8") as f:
    f.write(html_content)
EOF
          fi
        done

    - name: Upload HTML results
      uses: actions/upload-artifact@v3
      with:
        name: ocr-html-results
        path: output_html/
